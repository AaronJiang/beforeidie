<?php	require('header.php');	require_once('data_funs.inc');		if(!is_auth()){		page_jump('account_page_login.php');	}?><script type='text/javascript'>$(document).ready(function(){	$('body').prop('id', 'page-dynamic');		//弹出回复框	$('.comment-cmd-new').click(function(){		var posterID = $(this).data('poster-id'),			logID = $(this).data('log-id'),			isRoot = $(this).data('is-root'),			parentCommentID = isRoot? 0: $(this).data('parent-comment-id'),			html = "";				//构建 HTML 块		html = "<div class='comment-wap clearfix'>"			+ "<div class='comment-content' contenteditable='true'></div>"			+ "<span class='comment-submit'>发表</span>"			+ "</div>";					//插入DOM		$(html).appendTo($(this).parents('.dynamic-item'))				.find('.comment-content')				.focus() //聚焦				.blur(function(){	//失焦则从DOM中删除					if($.trim($(this).text()) == ""){						$(this).parent().detach();					}				})			.next()				.click(function(){	//提交回复					var comment = $(this).prev().text();					$.ajax({						url: 'comment_proc.php',						type: 'post',						data: {							'proc': 'new',							'comment': comment,							'posterID': posterID,							'logID': logID,							'parentCommentID': parentCommentID,							'isRoot': isRoot						}					});										//删除回复框					$(this).parent().detach();										//刷新页面					location.reload();				});	});	});</script><div id='dynamic-panel'>	<div id='dynamic-type-wap'>		<a class='dynamic-type dynamic-type-others' href='dynamic.php?type=others'>好友动态</a		><a class='dynamic-type dynamic-type-me' href='dynamic.php?type=me'>与我相关</a>	</div><?php	$userID = $_SESSION['valid_user_id'];	$dynamicType = isset($_REQUEST['type'])? $_REQUEST['type']: 'others';		if($dynamicType == 'others'){		//好友动态		$dyns = get_followee_dynamics($userID);				foreach($dyns as $dyn){			echo "<div class='dynamic-item clearfix'>";						//若为 Log 相关的动态			if($dyn['type'] == 'newLog'){								echo "<a href='person.php?userID=". $dyn['PosterID']. "'>"						. "<img class='dynamic-poster-profile' 								title='". $dyn['Poster']. "' 								src='". get_user_profile($dyn['PosterID']). "' />"					. "</a>"					."<div class='dynamic-content-wap'>"						. "<p class='dynamic-header'>"									. "<a class='dynamic-goal-creater' href='person.php?userID=". $dyn['PosterID']. "'>". $dyn['Poster']. "</a>"							. " 在 "							. "<a href='goal_page_details.php?goalID=". $dyn['GoalID']. "' class='dynamic-goal-title'>". $dyn['GoalTitle']. "</a>"							. " 中写到："						. "</p>";						//Log的标题和内容						if($dyn['LogTitle'] != ""){							echo "<p class='dynamic-log-title'>". $dyn['LogTitle']. "</p>";						}						echo "<p class='dynamic-log-content'>". $dyn['LogContent']. "</p>"					. "</div>"					//时间和命令					. "<div class='dynamic-footer'>"						. "<a class='small-cmd comment-cmd-new'								data-poster-id='". $_SESSION['valid_user_id']. "'								data-log-id='". $dyn['LogID']. "'								data-is-root='1'>回复</a>"						. "<p class='dynamic-time'>". $dyn['Time']. "</p>"					. "</div>";										//回复					$comments = get_log_comments($dyn['LogID']);					if(count($comments) == 0){						echo "</div>";						continue;					}					echo "<div class='comments-wap'>";					foreach($comments as $comm){						$posterID = $comm['PosterID'];						$poster = get_username_by_id($comm['PosterID']);						echo "<div class='comment-item clearfix'>"								//回复者头像								. "<a href='person.php?userID=". $comm['PosterID']. "'>"									. "<img class='comment-poster-profile'											title='". $poster. "'											src='". get_user_profile($comm['PosterID']). "'/>"								. "</a>"																//回复主体								. "<div class='comment-main'>"									//回复头									. "<div class='comment-header'>";										if($comm['IsRoot']){											echo "<a href='person.php?userID=". $posterID. "'>". $poster. "</a>"												. " : "												. $comm['Comment'];										}										else {											$receiverID = get_posterid_by_commentid($comm['ParentCommentID']);											$receiver = get_username_by_id($receiverID);											echo "<a href='person.php?userID=". $posterID. "'>". $poster. "</a>"												. " : "												. "<a href='person.php?userID=". $receiverID. "'>@". $receiver. "</a> "												. $comm['Comment'];										}									echo "</div>"														//回复时间和操作按钮									. "<div class='comment-time-cmd-wap'>"											. "<span class='comment-time'>". $comm['Time']. "</span>"											. "&nbsp;"											. "<span class='comment-cmd comment-cmd-new'													data-log-id='". $dyn['LogID']. "'													data-parent-comment-id='". $comm['CommentID']. "'													data-poster-id='". $_SESSION['valid_user_id']. "'													data-is-root='0'>回复<span>"									. "</div>"								. "</div>"							. "</div>";					}					echo "</div>";								}			else if($dyn['type'] == 'newGoal'){				//若为 Goal 相关的动态				echo "<a href='person.php?userID=". $dyn['PosterID']. "'>"						. "<img class='dynamic-poster-profile' 								title='". $dyn['Poster']. "' 								src='". get_user_profile($dyn['PosterID']). "' />"					. "</a>"					. "<div class='dynamic-content-wap'>" 						. "<p class='dynamic-header'>"								. "<a class='dynamic-goal-creater' href='person.php?userID=". $dyn['PosterID']. "'>". $dyn['Poster']. "</a>"							. " 设立目标 "							. "<a href='goal_page_details.php?goalID=". $dyn['GoalID']. "' class='dynamic-goal-title'>". $dyn['GoalTitle']. "</a>"						. "</p>"						. "<p class='dynamic-goal-reason'>". $dyn['GoalReason']. "</p>"					. "</div>"					. "<div class='dynamic-footer'>";						$isCheered = check_goal_is_cheered($_SESSION['valid_user_id'], $dyn['GoalID']);						if(!$isCheered){							echo "<a class='small-cmd' href='cheer_proc.php?proc=cheer&userID=". $_SESSION['valid_user_id']. "&goalID=". $dyn['GoalID']. "'>鼓励</a>";						}						echo "<p class='dynamic-time'>". $dyn['Time']. "</p>"					. "</div>";			}						echo "</div>";		}	}	else if($dynamicType == 'me'){		//与我相关		$dyns = get_dynamics_about_me($userID);		foreach($dyns as $dyn){			echo "<div class='dynamic-item clearfix'>";						if($dyn['type'] == 'newComment'){				//若为评论				echo "<a href='person.php?userID=". $dyn['PosterID']. "'>"						. "<img class='dynamic-poster-profile' 								title='". $dyn['Poster']. "' 								src='". get_user_profile($dyn['PosterID']). "' />"					. "</a>"					."<div class='dynamic-content-wap'>"						. "<p class='dynamic-header'>"							. "<a class='dynamic-goal-creater' href='person.php?userID=". $dyn['PosterID']. "'>". $dyn['Poster']. "</a>"							. " 评论了我的目标 "							. "<a href='goal_page_details.php?goalID=". $dyn['GoalID']. "' class='dynamic-goal-title'>". $dyn['GoalTitle']. "</a>"							. "："							. "<div class='dynamic-log-wap'>"								. "<p class='dynamic-log-title'>". $dyn['LogTitle']. "</p>"								. "<p class='dynamic-log-content'>". $dyn['LogContent']. "</p>"							. "</div>"						. "</p>"						. "<p class='dynamic-comment'>". $dyn['Comment']. "</p>"					. "</div>"					. "<div class='dynamic-footer'>"						. "<a class='small-cmd comment-cmd-new'								data-poster-id='". $_SESSION['valid_user_id']. "'								data-log-id='". $dyn['LogID']. "'								data-is-root='0'								data-parent-comment-id='". $dyn['CommentID']. "'>回复</a>"						. "<p class='dynamic-time'>". $dyn['Time']. "</p>"					. "</div>";			}			else if($dyn['type'] == 'newCheer'){				//若为鼓励				echo "<a href='person.php?userID=". $dyn['PosterID']. "'>"						. "<img class='dynamic-poster-profile' 								title='". $dyn['Poster']. "' 								src='". get_user_profile($dyn['PosterID']). "' />"					. "</a>"					."<div class='dynamic-content-wap'>"						."<p class='dynamic-header'>"							. "<a class='dynamic-goal-creater' href='person.php?userID=". $dyn['PosterID']. "'>". $dyn['Poster']. "</a>"							. " 鼓励了我的目标 "							. "<a href='goal_page_details.php?goalID=". $dyn['GoalID']. "' class='dynamic-goal-title'>". $dyn['GoalTitle']. "</a>"						. "</p>"					. "</div>"					. "<div class='dynamic-footer'>"						. "<p class='dynamic-time'>". $dyn['Time']. "</p>"					. "</div>";			}						echo "</div>";			}	}?></div><div id='dynamic-sidebar-panel'>	<!-- 个人关注 -->	<div class='panel-header'>		<div class='panel-title'>我的关注</div		><div class='panel-cmd-wapper'>......（<span class='panel-cmd' id='cmd-add-log'>管理</span>）</div>	</div>		<?php 		$followees = get_followed_users($userID);				foreach($followees as $fow){			echo "<a title='". $fow['Username']. "' href='person.php?userID=". $fow['UserID'] ."'>"					. "<img class='multi-user-profile' src='". get_user_profile($fow['UserID']). "' />"				. "<a>";		}	?></div><?php	require('footer.php');?>